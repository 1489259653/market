-- 进货管理模块测试数据脚本
-- 为market数据库创建进货相关的测试数据

USE market;

-- 1. 首先检查并创建必要的表结构（如果不存在）
-- 确保Users表有测试数据
INSERT IGNORE INTO Users (Id, Username, PasswordHash, Role, CreatedAt) VALUES
('USER001', 'admin', MD5('admin123'), 0, NOW()),
('USER002', 'warehouse', MD5('warehouse123'), 2, NOW()),
('USER003', 'cashier', MD5('cashier123'), 1, NOW());

-- 2. 确保Suppliers表有测试数据
INSERT IGNORE INTO Suppliers (Id, Name, Contact, Phone, Email, Address, ProductionLocation, CreatedAt) VALUES
('SUP001', '统一食品有限公司', '张经理', '13800138001', 'zhang@tongyi.com', '北京市朝阳区建国路100号', '北京', NOW()),
('SUP002', '康师傅饮料集团', '李主任', '13800138002', 'li@kangshifu.com', '上海市浦东新区张江高科技园区', '上海', NOW()),
('SUP003', '宝洁日用品公司', '王总监', '13800138003', 'wang@baojie.com', '广州市天河区珠江新城', '广州', NOW()),
('SUP004', '金龙鱼粮油公司', '赵总', '13800138004', 'zhao@jinlongyu.com', '深圳市南山区科技园', '深圳', NOW()),
('SUP005', '得力文具制造', '钱厂长', '13800138005', 'qian@deli.com', '杭州市西湖区文三路', '杭州', NOW());

-- 3. 确保Products表有基础商品数据
INSERT IGNORE INTO Products (ProductCode, Name, Price, Quantity, Unit, Category, StockAlertThreshold, PurchasePrice, SupplierId, LastUpdated) VALUES
('P001', '统一绿茶500ml', 3.50, 100, '瓶', '饮料', 20, 2.80, 'SUP002', NOW()),
('P002', '康师傅红烧牛肉面', 4.50, 80, '袋', '食品', 15, 3.20, 'SUP001', NOW()),
('P003', '海飞丝去屑洗发水400ml', 35.00, 50, '瓶', '日用品', 10, 25.00, 'SUP003', NOW()),
('P004', '金龙鱼大豆油5L', 65.00, 30, '桶', '粮油', 5, 45.00, 'SUP004', NOW()),
('P005', '得力中性笔黑色', 2.50, 200, '支', '文具', 50, 1.50, 'SUP005', NOW()),
('P006', '可口可乐330ml', 3.00, 150, '罐', '饮料', 30, 2.20, 'SUP002', NOW()),
('P007', '奥利奥饼干', 8.50, 60, '袋', '食品', 10, 6.00, 'SUP001', NOW()),
('P008', '飘柔洗发水750ml', 28.00, 40, '瓶', '日用品', 8, 20.00, 'SUP003', NOW()),
('P009', '福临门大米10kg', 65.00, 25, '袋', '粮油', 5, 45.00, 'SUP004', NOW()),
('P010', '真彩圆珠笔蓝色', 1.80, 180, '支', '文具', 40, 1.00, 'SUP005', NOW());

-- 4. 创建进货单主表测试数据
INSERT IGNORE INTO PurchaseOrders (OrderNumber, OrderDate, SupplierId, OperatorId, Status, TotalAmount, TaxAmount, FinalAmount, Notes, CreatedAt, UpdatedAt, CompletedAt) VALUES
-- 已完成订单
('PO20240115001', '2024-01-15', 'SUP001', 'USER002', 3, 12500.00, 1250.00, 13750.00, '常规补货', '2024-01-15 09:30:00', '2024-01-16 14:20:00', '2024-01-16 14:20:00'),
('PO20240120001', '2024-01-20', 'SUP002', 'USER002', 3, 9800.00, 980.00, 10780.00, '饮料促销备货', '2024-01-20 10:15:00', '2024-01-21 16:30:00', '2024-01-21 16:30:00'),
('PO20240125001', '2024-01-25', 'SUP003', 'USER002', 3, 15600.00, 1560.00, 17160.00, '日用品季度补货', '2024-01-25 11:00:00', '2024-01-26 15:45:00', '2024-01-26 15:45:00'),

-- 已审核待收货订单
('PO20240201001', '2024-02-01', 'SUP004', 'USER002', 1, 8700.00, 870.00, 9570.00, '粮油类商品补货', '2024-02-01 14:20:00', '2024-02-01 16:10:00', NULL),
('PO20240205001', '2024-02-05', 'SUP005', 'USER002', 1, 5600.00, 560.00, 6160.00, '文具类商品补货', '2024-02-05 09:45:00', '2024-02-05 11:30:00', NULL),

-- 待审核订单
('PO20240210001', '2024-02-10', 'SUP001', 'USER002', 0, 4200.00, 420.00, 4620.00, '食品临时补货', '2024-02-10 13:15:00', '2024-02-10 13:15:00', NULL),
('PO20240210002', '2024-02-10', 'SUP002', 'USER002', 0, 3100.00, 310.00, 3410.00, '饮料临时补货', '2024-02-10 15:30:00', '2024-02-10 15:30:00', NULL),

-- 已到货订单
('PO20240208001', '2024-02-08', 'SUP003', 'USER002', 2, 6800.00, 680.00, 7480.00, '日用品到货', '2024-02-08 10:00:00', '2024-02-09 09:20:00', NULL),

-- 已取消订单
('PO20240130001', '2024-01-30', 'SUP004', 'USER002', 4, 9500.00, 950.00, 10450.00, '供应商价格调整，重新下单', '2024-01-30 16:45:00', '2024-01-31 10:30:00', NULL);

-- 5. 创建进货明细测试数据
INSERT IGNORE INTO PurchaseOrderItems (Id, OrderNumber, ProductCode, ProductName, Quantity, PurchasePrice, Amount, ExpiryDate, BatchNumber, Notes) VALUES
-- PO20240115001 明细
(UUID(), 'PO20240115001', 'P002', '康师傅红烧牛肉面', 500, 3.20, 1600.00, '2024-07-15', 'BATCH202401001', '120g袋装'),
(UUID(), 'PO20240115001', 'P007', '奥利奥饼干', 300, 6.00, 1800.00, '2024-08-20', 'BATCH202401002', '原味夹心'),
(UUID(), 'PO20240115001', 'P001', '统一绿茶500ml', 1000, 2.80, 2800.00, '2024-06-30', 'BATCH202401003', '无糖型'),
(UUID(), 'PO20240115001', 'P006', '可口可乐330ml', 1500, 2.20, 3300.00, '2024-07-10', 'BATCH202401004', '罐装'),

-- PO20240120001 明细
(UUID(), 'PO20240120001', 'P001', '统一绿茶500ml', 1200, 2.80, 3360.00, '2024-07-15', 'BATCH202401005', '促销备货'),
(UUID(), 'PO20240120001', 'P006', '可口可乐330ml', 1600, 2.20, 3520.00, '2024-07-20', 'BATCH202401006', '夏季热销'),
(UUID(), 'PO20240120001', 'P002', '康师傅红烧牛肉面', 400, 3.20, 1280.00, '2024-08-01', 'BATCH202401007', '常规补货'),

-- PO20240125001 明细
(UUID(), 'PO20240125001', 'P003', '海飞丝去屑洗发水400ml', 200, 25.00, 5000.00, '2025-12-31', 'BATCH202401008', '去屑型'),
(UUID(), 'PO20240125001', 'P008', '飘柔洗发水750ml', 300, 20.00, 6000.00, '2025-12-31', 'BATCH202401009', '柔顺型'),
(UUID(), 'PO20240125001', 'P007', '奥利奥饼干', 200, 6.00, 1200.00, '2024-08-15', 'BATCH202401010', '巧克力味'),
(UUID(), 'PO20240125001', 'P002', '康师傅红烧牛肉面', 300, 3.20, 960.00, '2024-08-20', 'BATCH202401011', '大包装'),

-- PO20240201001 明细
(UUID(), 'PO20240201001', 'P004', '金龙鱼大豆油5L', 100, 45.00, 4500.00, '2024-09-30', 'BATCH202402001', '一级压榨'),
(UUID(), 'PO20240201001', 'P009', '福临门大米10kg', 80, 45.00, 3600.00, '2024-10-15', 'BATCH202402002', '东北大米'),

-- PO20240205001 明细
(UUID(), 'PO20240205001', 'P005', '得力中性笔黑色', 2000, 1.50, 3000.00, NULL, 'BATCH202402003', '0.5mm'),
(UUID(), 'PO20240205001', 'P010', '真彩圆珠笔蓝色', 1500, 1.00, 1500.00, NULL, 'BATCH202402004', '蓝色墨水'),

-- PO20240210001 明细
(UUID(), 'PO20240210001', 'P007', '奥利奥饼干', 300, 6.00, 1800.00, '2024-09-01', 'BATCH202402005', '草莓味'),
(UUID(), 'PO20240210001', 'P002', '康师傅红烧牛肉面', 400, 3.20, 1280.00, '2024-09-10', 'BATCH202402006', '家庭装'),

-- PO20240210002 明细
(UUID(), 'PO20240210002', 'P001', '统一绿茶500ml', 500, 2.80, 1400.00, '2024-08-15', 'BATCH202402007', '柠檬味'),
(UUID(), 'PO20240210002', 'P006', '可口可乐330ml', 600, 2.20, 1320.00, '2024-08-20', 'BATCH202402008', '零度'),

-- PO20240208001 明细
(UUID(), 'PO20240208001', 'P003', '海飞丝去屑洗发水400ml', 150, 25.00, 3750.00, '2025-12-31', 'BATCH202402009', '清爽型'),
(UUID(), 'PO20240208001', 'P008', '飘柔洗发水750ml', 100, 20.00, 2000.00, '2025-12-31', 'BATCH202402010', '滋养型'),

-- PO20240130001 明细
(UUID(), 'PO20240130001', 'P004', '金龙鱼大豆油5L', 150, 45.00, 6750.00, '2024-09-15', 'BATCH202401012', '已取消'),
(UUID(), 'PO20240130001', 'P009', '福临门大米10kg', 100, 45.00, 4500.00, '2024-10-01', 'BATCH202401013', '已取消');

-- 6. 创建库存变动历史记录
INSERT IGNORE INTO InventoryHistory (Id, ProductCode, QuantityChange, OperationType, OperationDate, OperatorId, PurchasePrice, OrderNumber) VALUES
-- 已完成订单的库存变动记录
(UUID(), 'P002', 500, '进货', '2024-01-16 14:20:00', 'USER002', 3.20, 'PO20240115001'),
(UUID(), 'P007', 300, '进货', '2024-01-16 14:20:00', 'USER002', 6.00, 'PO20240115001'),
(UUID(), 'P001', 1000, '进货', '2024-01-16 14:20:00', 'USER002', 2.80, 'PO20240115001'),
(UUID(), 'P006', 1500, '进货', '2024-01-16 14:20:00', 'USER002', 2.20, 'PO20240115001'),

(UUID(), 'P001', 1200, '进货', '2024-01-21 16:30:00', 'USER002', 2.80, 'PO20240120001'),
(UUID(), 'P006', 1600, '进货', '2024-01-21 16:30:00', 'USER002', 2.20, 'PO20240120001'),
(UUID(), 'P002', 400, '进货', '2024-01-21 16:30:00', 'USER002', 3.20, 'PO20240120001'),

(UUID(), 'P003', 200, '进货', '2024-01-26 15:45:00', 'USER002', 25.00, 'PO20240125001'),
(UUID(), 'P008', 300, '进货', '2024-01-26 15:45:00', 'USER002', 20.00, 'PO20240125001'),
(UUID(), 'P007', 200, '进货', '2024-01-26 15:45:00', 'USER002', 6.00, 'PO20240125001'),
(UUID(), 'P002', 300, '进货', '2024-01-26 15:45:00', 'USER002', 3.20, 'PO20240125001');

-- 7. 更新商品库存数量（基于进货记录）
UPDATE Products 
SET Quantity = Quantity + (
    SELECT COALESCE(SUM(QuantityChange), 0) 
    FROM InventoryHistory 
    WHERE InventoryHistory.ProductCode = Products.ProductCode 
    AND OperationType = '进货'
)
WHERE ProductCode IN ('P001', 'P002', 'P003', 'P006', 'P007', 'P008');

-- 显示数据插入结果
SELECT '进货管理测试数据插入完成' AS Result;
SELECT COUNT(*) AS '用户数量' FROM Users;
SELECT COUNT(*) AS '供应商数量' FROM Suppliers;
SELECT COUNT(*) AS '商品数量' FROM Products;
SELECT COUNT(*) AS '进货单数量' FROM PurchaseOrders;
SELECT COUNT(*) AS '进货明细数量' FROM PurchaseOrderItems;
SELECT COUNT(*) AS '库存变动记录数量' FROM InventoryHistory;

-- 显示各种状态的进货单统计
SELECT 
    CASE Status 
        WHEN 0 THEN '待审核'
        WHEN 1 THEN '已审核'
        WHEN 2 THEN '已到货'
        WHEN 3 THEN '已完成'
        WHEN 4 THEN '已取消'
    END AS '订单状态',
    COUNT(*) AS '订单数量',
    SUM(FinalAmount) AS '总金额'
FROM PurchaseOrders 
GROUP BY Status 
ORDER BY Status;